<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ASKAB PSSI KEPULAUAN MENTAWAI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #0d6efd;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
    }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
    .header { background: #001f3f; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; }
    .header img { height: 50px; border-radius: 8px; }
    .header h5 { margin: 0; font-weight: 600; }
    .search-bar { margin: 15px; }
    .card { border: none; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn-floating { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; }
    .toast { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); z-index: 1050; min-width: 300px; }
    .modal { z-index: 1060; }
    .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #ddd; z-index: 100; }
    .nav-bottom .nav-link { color: #555; padding: 12px; text-align: center; }
    .nav-bottom .nav-link.active { color: var(--primary); }
    .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1070; }
    img { max-width: 100%; height: auto; }
    @media (min-width: 768px) {
      .container { max-width: 900px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div id="header" class="header"></div>

  <!-- Main Content -->
  <div class="container mt-3" id="main-content">
    <div id="home-page"></div>
    <div id="kompetisi-page" class="d-none"></div>
    <div id="klub-page" class="d-none"></div>
    <div id="setting-page" class="d-none"></div>
  </div>

  <!-- FAB -->
  <button class="btn btn-primary btn-floating" id="fab-btn">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Toast -->
  <div class="toast align-items-center text-white bg-success border-0" role="alert" id="toast">
    <div class="d-flex">
      <div class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="nav-bottom">
    <div class="d-flex justify-content-around">
      <a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i><br><small>Home</small></a>
      <a href="#" class="nav-link" data-page="kompetisi"><i class="fas fa-trophy"></i><br><small>Kompetisi</small></a>
      <a href="#" class="nav-link" data-page="klub"><i class="fas fa-users"></i><br><small>Klub</small></a>
      <a href="#" class="nav-link" data-page="setting"><i class="fas fa-cog"></i><br><small>Setting</small></a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // GANTI DENGAN URL WEB APP ANDA
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx.../exec'; // â† GANTI INI

    const sheets = {
      kepala_halaman: { editable: false },
      banner: { editable: false },
      berita_home: { id: 'id_berita', prefix: 'BRT' },
      kompetisi: { id: 'id_pertandingan', prefix: 'TND' },
      klub: { id: 'id_klub', prefix: 'APM' },
      profil: { editable: false },
      struktur_organisasi: { editable: false }
    };

    let currentPage = 'home';
    let currentData = {};
    let editingId = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadHeader();
      showPage('home');
      setupNavigation();
      preventBack();
    });

    function preventBack() {
      history.pushState(null, null, location.href);
      window.onpopstate = () => history.go(1);
    }

    function setupNavigation() {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const page = link.dataset.page;
          showPage(page);
        });
      });
    }

    function showPage(page) {
      currentPage = page;
      document.querySelectorAll('#main-content > div').forEach(d => d.classList.add('d-none'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`.nav-link[data-page="${page}"]`).classList.add('active');
      document.getElementById(`${page}-page`).classList.remove('d-none');

      if (page === 'home') loadHome();
      if (page === 'kompetisi') loadKompetisi();
      if (page === 'klub') loadKlub();
      if (page === 'setting') loadSetting();

      editingId = null;
      document.getElementById('fab-btn').onclick = () => openForm(page);
    }

    async function loadHeader() {
      const data = await fetchData('kepala_halaman');
      if (data.rows[0]) {
        const row = data.rows[0];
        document.getElementById('header').innerHTML = `
          <img src="${row.logo_pssi}" alt="PSSI" onerror="this.src='https://via.placeholder.com/50?text=PSSI'">
          <h5 class="text-center flex-fill">${row.judul_kepala}</h5>
          <img src="${row.logo_askab}" alt="ASKAB" onerror="this.src='https://via.placeholder.com/50?text=ASKAB'">
        `;
      }
    }

    // === HOME PAGE ===
    async function loadHome() {
      const container = document.getElementById('home-page');
      container.innerHTML = `
        <div class="search-bar">
          <input type="text" class="form-control" placeholder="Cari berita..." id="search-berita">
        </div>
        <div id="berita-list"></div>
      `;

      await loadBerita();
      document.getElementById('search-berita').addEventListener('input', filterBerita);
    }

    async function loadBerita() {
      const data = await fetchData('berita_home');
      currentData.berita = data.rows.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
      renderBerita();
    }

    function renderBerita(filter = '') {
      const list = document.getElementById('berita-list');
      const filtered = currentData.berita.filter(b => 
        b.Judul_Berita.toLowerCase().includes(filter.toLowerCase()) ||
        b.isi_berita.toLowerCase().includes(filter.toLowerCase())
      );

      list.innerHTML = filtered.map(b => `
        <div class="card mb-3">
          <div class="row g-0">
            ${b.gambar_1 ? `<div class="col-4"><img src="${b.gambar_1}" class="img-fluid rounded-start"></div>` : ''}
            <div class="col${b.gambar_1 ? '-8' : ''}">
              <div class="card-body">
                <h6 class="card-title">${b.Judul_Berita}</h6>
                <p class="text-muted small">${formatDate(b.tanggal)}</p>
                <p class="card-text">${truncate(b.isi_berita, 100)}</p>
                <button class="btn btn-sm btn-outline-primary" onclick="editBerita('${b.id_berita}')">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('berita_home', '${b.id_berita}', loadBerita)">Hapus</button>
              </div>
            </div>
          </div>
        </div>
      `).join('') || '<p class="text-center text-muted">Tidak ada berita</p>';
    }

    function filterBerita() {
      const query = this.value;
      renderBerita(query);
    }

    // === KOMPETISI & KLUB (SAMA STRUKTUR) ===
    async function loadKompetisi() {
      const container = document.getElementById('kompetisi-page');
      container.innerHTML = `
        <div class="search-bar">
          <input type="text" class="form-control" placeholder="Cari kompetisi..." id="search-kompetisi">
        </div>
        <div id="kompetisi-list"></div>
      `;
      await loadList('kompetisi', 'kompetisi-list', 'search-kompetisi');
    }

    async function loadKlub() {
      const container = document.getElementById('klub-page');
      container.innerHTML = `
        <div class="search-bar">
          <input type="text" class="form-control" placeholder="Cari klub..." id="search-klub">
        </div>
        <div id="klub-list"></div>
      `;
      await loadList('klub', 'klub-list', 'search-klub');
    }

    async function loadList(sheet, listId, searchId) {
      const data = await fetchData(sheet);
      currentData[sheet] = data.rows.sort((a,b) => new Date(b.tanggal || b.tanggal_berdiri) - new Date(a.tanggal || a.tanggal_berdiri));
      renderList(sheet, listId, '');
      document.getElementById(searchId).addEventListener('input', function() {
        renderList(sheet, listId, this.value);
      });
    }

    function renderList(sheet, listId, filter) {
      const list = document.getElementById(listId);
      const key = sheet === 'kompetisi' ? 'nama_kompetisi' : 'nama_klub';
      const filtered = currentData[sheet].filter(r => r[key].toLowerCase().includes(filter.toLowerCase()));

      list.innerHTML = filtered.map(r => `
        <div class="card mb-2">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <strong>${r[key]}</strong><br>
              <small class="text-muted">${formatDate(r.tanggal || r.tanggal_berdiri)}</small>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary" onclick="editRecord('${sheet}', '${r[sheets[sheet].id]}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${sheet}', '${r[sheets[sheet].id]}', () => loadList('${sheet}', '${listId}', document.getElementById('search-${sheet.replace('i','')}').value))">Hapus</button>
            </div>
          </div>
        </div>
      `).join('') || '<p class="text-center text-muted">Tidak ada data</p>';
    }

    // === SETTING PAGE ===
    async function loadSetting() {
      const container = document.getElementById('setting-page');
      const sections = ['kepala_halaman', 'banner', 'profil', 'struktur_organisasi'];
      container.innerHTML = sections.map(s => `
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between">
            <strong>${s.replace(/_/g, ' ').toUpperCase()}</strong>
            <button class="btn btn-sm btn-primary" onclick="openForm('setting', '${s}')">Edit</button>
          </div>
          <div class="card-body" id="${s}-preview"></div>
        </div>
      `).join('');

      for (const s of sections) {
        const data = await fetchData(s);
        if (data.rows[0]) renderSettingPreview(s, data.rows[0]);
      }
    }

    function renderSettingPreview(sheet, row) {
      const el = document.getElementById(`${sheet}-preview`);
      if (sheet === 'banner') {
        el.innerHTML = Object.keys(row).filter(k => k.startsWith('poto')).map(k => `<img src="${row[k]}" class="me-2" style="height:80px; object-fit:cover;">`).join('');
      } else {
        el.innerHTML = Object.entries(row).map(([k,v]) => `<small><strong>${k.replace(/_/g,' ')}:</strong> ${v}</small><br>`).join('');
      }
    }

    // === FORM HANDLING ===
    window.openForm = async function(page, sheetName = null) {
      const sheet = sheetName || (page === 'home' ? 'berita_home' : page);
      const data = sheetName ? (await fetchData(sheet)).rows[0] : null;
      editingId = data ? data[Object.keys(data)[0]] : null;

      const headers = (await fetchData(sheet)).headers;
      const formHtml = generateForm(sheet, headers, data);
      showModal('Form Data', formHtml, () => submitForm(sheet));
    };

    window.editBerita = id => { editingId = id; openForm('home'); };
    window.editRecord = (sheet, id) => { editingId = id; openForm('setting', sheet); };

    function generateForm(sheet, headers, record) {
      return `
        <form id="data-form">
          ${headers.map(h => {
            const val = record ? record[h] : '';
            const type = h.includes('tanggal') ? 'date' : 
                        h.includes('goal') || h.includes('kartu') || h.includes('no_handphone') ? 'number' :
                        h.includes('pilihan') || h === 'jenis_pertandingan' ? 'select' : 'text';
            const readonly = !sheets[sheet].editable && record ? 'readonly' : 
                            h === headers[0] ? 'readonly' : '';

            if (type === 'select') {
              const opts = h === 'nama_kompetisi' ? ['Liga Askab', 'Liga Bupati', 'Liga Desa'] :
                           ['Babak Fase Group', 'Babak Penyisihan', 'Babak 16 Besar', 'Babak Semifinal', 'Final'];
              return `<div class="mb-2">
                <label class="form-label small">${h.replace(/_/g,' ')}</label>
                <select class="form-control form-control-sm" name="${h}" ${readonly}>${opts.map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('')}</select>
              </div>`;
            }

            if (h.includes('gambar') || h.includes('logo') || h.includes('poto')) {
              return `<div class="mb-2">
                <label class="form-label small">${h.replace(/_/g,' ')}</label>
                <input type="file" class="form-control form-control-sm" accept="image/*" onchange="uploadImg(this, '${h}')">
                <input type="hidden" name="${h}" value="${val}">
                ${val ? `<img src="${val}" class="mt-2" style="max-height:100px;">` : ''}
              </div>`;
            }

            if (h === 'isi_berita') {
              return `<div class="mb-2">
                <label class="form-label small">Isi Berita</label>
                <textarea class="form-control" rows="5" name="${h}">${val}</textarea>
              </div>`;
            }

            return `<div class="mb-2">
              <label class="form-label small">${h.replace(/_/g,' ')}</label>
              <input type="${type}" class="form-control form-control-sm" name="${h}" value="${val}" ${readonly}>
            </div>`;
          }).join('')}
        </form>
      `;
    }

    async function uploadImg(input, field) {
      const file = input.files[0];
      if (!file) return;
      showLoading(true);
      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(',')[1];
        const res = await fetch(`${SCRIPT_URL}?action=uploadImage&file=${base64}&filename=${file.name}`).then(r => r.json());
        showLoading(false);
        if (res.success) {
          document.querySelector(`input[name="${field}"]`).value = res.url;
          input.nextElementSibling.nextElementSibling.src = res.url;
        } else {
          toast('Upload gagal: ' + res.error, 'danger');
        }
      };
      reader.readAsDataURL(file);
    }

    async function submitForm(sheet) {
      const form = document.getElementById('data-form');
      const data = {};
      new FormData(form).forEach((v, k) => data[k] = v);

      showLoading(true);
      const action = editingId ? 'updateData' : 'addData';
      const res = await fetch(`${SCRIPT_URL}?action=${action}&sheet=${sheet}&data=${JSON.stringify(data)}`).then(r => r.json());
      showLoading(false);

      if (res.success) {
        toast(editingId ? 'Diperbarui!' : 'Ditambahkan!');
        bootstrap.Modal.getInstance(document.getElementById('modal')).hide();
        refreshPage();
      } else {
        toast('Error: ' + res.error, 'danger');
      }
    }

    async function deleteRecord(sheet, id, callback) {
      if (!confirm('Hapus data ini?')) return;
      showLoading(true);
      const res = await fetch(`${SCRIPT_URL}?action=deleteData&sheet=${sheet}&id=${id}`).then(r => r.json());
      showLoading(false);
      if (res.success) {
        toast('Dihapus!');
        callback();
      } else {
        toast('Gagal hapus', 'danger');
      }
    }

    // === UTILS ===
    async function fetchData(sheet) {
      const res = await fetch(`${SCRIPT_URL}?action=getData&sheet=${sheet}`);
      return await res.json();
    }

    function showModal(title, body, onSave) {
      const modal = new bootstrap.Modal(document.getElementById('modal') || createModal());
      document.querySelector('#modal .modal-title').textContent = title;
      document.querySelector('#modal .modal-body').innerHTML = body;
      document.querySelector('#modal .btn-primary').onclick = onSave;
      modal.show();
    }

    function createModal() {
      const div = document.createElement('div');
      div.className = 'modal fade';
      div.id = 'modal';
      div.innerHTML = `
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
              <button type="button" class="btn btn-primary">Simpan</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(div);
      return div;
    }

    function toast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.className = `toast align-items-center text-white bg-${type} border-0`;
      t.querySelector('.toast-body').textContent = msg;
      new bootstrap.Toast(t, { delay: 3000 }).show();
    }

    function showLoading(show) {
      document.querySelector('.loading').classList.toggle('d-none', !show);
    }

    function refreshPage() {
      if (currentPage === 'home') loadHome();
      else if (currentPage === 'kompetisi') loadKompetisi();
      else if (currentPage === 'klub') loadKlub();
      else if (currentPage === 'setting') loadSetting();
    }

    function formatDate(d) {
      return new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function truncate(str, n) {
      return str.length > n ? str.substr(0, n-1) + '...' : str;
    }
  </script>
</body>
</html>
